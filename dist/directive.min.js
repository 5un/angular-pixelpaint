/*!
 * angular-directive-boilerplate
 * 
 * Version: 0.0.8 - 2016-06-16T09:14:54.928Z
 * License: MIT
 */
/*!
 * angular-directive-boilerplate
 * 
 * Version: 0.0.8 - 2016-06-16T07:54:28.642Z
 * License: MIT
 */
"use strict";angular.module("angularPixelPaint",[]).directive("pixelPaint",["$document","$window","$q","$timeout","$log",function(e,t,i,a,n){function l(i,n){var l,r,o,c,s=e[0].createElement("canvas"),d=s.getContext("2d");n.addClass("pixelpaint");var g=angular.element(n[0].querySelector(".layers-container")),h=[],f={cellSize:10,largeGridEvery:10,gridLineWidth:1,gridSubDivisionLineWidth:.5,imageWidth:54,imageHeight:36,showGrid:!0,brushColor:[0,0,0],paintEnabled:!0},u={x:0,y:0},v={x:0,y:0};l=i.$watch("options",function(e,t){f=Object.assign(f,i.options),e.cellSize!==t.cellSize&&angular.forEach(h,function(e){e.element[0].width=f.imageWidth*f.cellSize,e.element[0].height=f.imageHeight*f.cellSize,e.element[0].style.transform="translate("+e.offset.x*f.cellSize+"px,"+e.offset.y*f.cellSize+"px)",L(e)}),n.css("width",f.imageWidth*f.cellSize+"px"),n.css("height",f.imageHeight*f.cellSize+"px")},!0),r=i.$watch("layers",function(e,t){S(e,t)},!0),o=i.$watch("shouldGenerateOutputImage",function(e){e&&(R(),a(function(){i.shouldGenerateOutputImage=!1}))}),c=i.$watch("revision",function(e){});var m=new Hammer(n[0]);m.on("tap",function(e){w(e)}),m.on("panstart",function(e){W(e)}),m.on("panmove",function(e){b(e)}),m.on("panend",function(e){D(e)});var S=function(e,t){angular.forEach(e,function(e,i){angular.isDefined(t)&&i<t.length?angular.equals(t[i],e)||p(e,i):p(e)})},p=function(t,i){var a={offset:{x:0,y:0}};i<h.length&&"text"===h[i].type&&(a.offset=h[i].offset);var n=Object.assign({},t,a);if(n.element=angular.element("<canvas></canvas>"),"text"===n.type&&n.element.addClass("text"),n.element[0].width=f.imageWidth*f.cellSize,n.element[0].height=f.imageHeight*f.cellSize,n.element[0].style.transform="translate("+n.offset.x*f.cellSize+"px,"+n.offset.y*f.cellSize+"px)",n.active&&n.element.addClass("active"),angular.isDefined(i)?(h[i]=n,g.find("canvas").eq(i).replaceWith(n.element)):(h.push(n),g.append(n.element)),n.dataCanvas=e[0].createElement("canvas"),n.dataCanvas.width=f.imageWidth,n.dataCanvas.height=f.imageHeight,n.image){var l=new Image;l.onload=function(){var e=n.dataCanvas.getContext("2d");e.drawImage(l,0,0),L(n)},l.src=n.image}else L(n)},x=function(e,t,i,a,n,l,r){var o=e.getContext("2d"),c=d.createImageData(1,1);c.data[0]=a,c.data[1]=n,c.data[2]=l,c.data[3]=r,o.putImageData(c,t,i)},y=function(){var e=h[0];return angular.forEach(h,function(t){t.active&&(e=t)}),e},z=function(e){angular.forEach(h,function(t,a){a===e?(t.active=!0,t.element.addClass("active"),a<i.layers.length&&(i.layers[a].active=!0)):(t.active=!1,t.element.removeClass("active"),a<i.layers.length&&(i.layers[a].active=!1))}),a(function(){i.$digest()})},C=function(e){var t=y();if(e.pointers.length>0){var i=t.element[0].getBoundingClientRect(),a=e.pointers[0].clientX-i.left,n=e.pointers[0].clientY-i.top,l=Math.floor(a/f.cellSize),r=Math.floor(n/f.cellSize);f.paintEnabled&&(x(t.dataCanvas,l,r,f.brushColor[0],f.brushColor[1],f.brushColor[2],255),$(t,l,r,f.brushColor[0],f.brushColor[1],f.brushColor[2],255))}},w=function(e){var t=y();if(e.target===t.element[0])"text"!==t.type&&C(e);else{var i;angular.forEach(h,function(t,a){t.element[0]===e.target&&(i=a)}),z(i)}},W=function(e){var t=y();"text"===t.type?(u.x=e.pointers[0].clientX,u.y=e.pointers[0].clientY,v.x=t.offset.x,v.y=t.offset.y):C(e)},b=function(e){var t=y();if("text"===t.type){var i=v.x*f.cellSize+(e.pointers[0].clientX-u.x),a=v.y*f.cellSize+(e.pointers[0].clientY-u.y);t.offset.x=Math.floor(i/f.cellSize),t.offset.y=Math.floor(a/f.cellSize),t.element[0].style.transform="translate("+t.offset.x*f.cellSize+"px,"+t.offset.y*f.cellSize+"px)"}else C(e)},D=function(){angular.forEach(h,function(e,t){"image"===e.type&&t<i.layers.length&&(i.layers[t].image=e.dataCanvas.toDataURL("image/png"))}),a(function(){i.$digest()})},L=function(e){"image"===e.type?I(e):"text"===e.type&&E(e)},E=function(e){var i=angular.element("<canvas></canvas>"),a=i[0];a.width=f.imageWidth,a.height=f.imageHeight;var n=a.getContext("2d");if(t.devicePixelRatio){var l=i.attr("width"),r=i.attr("height"),o=l,c=r;i.attr("width",l*t.devicePixelRatio),i.attr("height",r*t.devicePixelRatio),i.css("width",o),i.css("height",c),n.scale(t.devicePixelRatio,t.devicePixelRatio)}var s=e.fontSize||"10px";n.font=s+" "+(e.fontFamily||"Arial");var d=e.text||"text";n.textBaseline="top",n.fillStyle=e.color,n.fillText(d,0,0);var g=n.measureText(d);e.element[0].width=g.width*f.cellSize,e.element[0].height=parseInt(s)*f.cellSize;for(var h,u=n.getImageData(0,0,f.imageWidth,f.imageHeight),v=0;v<u.height;v++)for(var m=0;m<u.width;m++)h=4*(v*u.width+m),u.data[h+3]=u.data[h+3]>50?255:0;var S=e.dataCanvas.getContext("2d");S.putImageData(u,0,0),I(e)},I=function(e){var t,i,a,n,l,r,o,c,s=e.element[0].getContext("2d"),d=e.dataCanvas.getContext("2d"),g=d.getImageData(0,0,f.imageWidth,f.imageHeight);s.clearRect(0,0,e.element[0].width,e.element[0].height);for(var h=0;h<g.height;h++)for(var u=0;u<g.width;u++)t=4*(h*g.width+u),i=g.data[t],a=g.data[t+1],n=g.data[t+2],r=g.data[t+3],l=r/255,f.showGrid?(o=f.gridSubDivisionLineWidth,c=f.gridSubDivisionLineWidth,u%f.largeGridEvery===0&&(o=f.gridLineWidth),h%f.largeGridEvery===0&&(c=f.gridLineWidth),s.fillStyle="rgba("+i+","+a+", "+n+", "+l+")",s.fillRect(.5+f.cellSize*u+f.gridSubDivisionLineWidth+o,.5+f.cellSize*h+f.gridSubDivisionLineWidth+c,f.cellSize-2*f.gridSubDivisionLineWidth-o,f.cellSize-2*f.gridSubDivisionLineWidth-c)):(s.fillStyle="rgba("+i+","+a+", "+n+", "+l+")",s.fillRect(f.cellSize*u,f.cellSize*h,f.cellSize,f.cellSize))},$=function(e,t,i,a,n,l,r){var o=e.element[0].getContext("2d");if(o.fillStyle="rgba("+a+","+n+", "+l+", "+r+")",f.showGrid){var c=f.gridSubDivisionLineWidth,s=f.gridSubDivisionLineWidth;t%f.largeGridEvery===0&&(c=f.gridLineWidth),i%f.largeGridEvery===0&&(s=f.gridLineWidth),o.fillRect(.5+f.cellSize*t+f.gridSubDivisionLineWidth+c,.5+f.cellSize*i+f.gridSubDivisionLineWidth+s,f.cellSize-2*f.gridSubDivisionLineWidth-c,f.cellSize-2*f.gridSubDivisionLineWidth-s)}else o.fillRect(f.cellSize*t,f.cellSize*i,f.cellSize,f.cellSize)},R=function(){var e=angular.element("<canvas></canvas>"),t=e[0];t.width=f.imageWidth,t.height=f.imageHeight;var a=t.getContext("2d");angular.forEach(h,function(e){a.drawImage(e.dataCanvas,e.offset.x,e.offset.y)}),i.outputImage=a.getImageData(0,0,f.imageWidth,f.imageHeight)};i.$on("$destroy",function(){l(),r(),o(),c()}),S(i.layers,[])}var r={restrict:"E",scope:{layers:"=",options:"=",shouldGenerateOutputImage:"=",outputImage:"=",revision:"="},template:'<div class="layers-container"></div>',link:l};return r}]);