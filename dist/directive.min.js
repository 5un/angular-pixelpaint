/*!
 * angular-directive-boilerplate
 * 
 * Version: 0.0.8 - 2016-06-17T09:21:27.419Z
 * License: MIT
 */
/*!
 * angular-directive-boilerplate
 * 
 * Version: 0.0.8 - 2016-06-16T07:54:28.642Z
 * License: MIT
 */
"use strict";angular.module("angularPixelPaint",[]).directive("pixelPaint",["$document","$window","$q","$timeout","$log",function(e,t,i,a,n){function l(e,t){t[0].style.overflow="scroll",t.css("width",t[0].style.width||"500px"),t.css("height",t[0].style.height||"500px")}function o(i,o){l(i,o),t.el=o;var r,s,c,d,g,f=e[0].createElement("canvas"),v=f.getContext("2d");o.addClass("pixelpaint");var h=angular.element(o[0].querySelector(".layers-container")),u=[],m={cellSize:10,largeGridEvery:10,gridLineWidth:1,gridSubDivisionLineWidth:.5,imageWidth:10,imageHeight:10,showGrid:!0,brushColor:[0,0,0],paintEnabled:!0},p="move",S={x:0,y:0},x={x:0,y:0};r=i.$watch("options",function(e,t){e.cellSize>0&&(m=Object.assign(m,i.options),e.cellSize!==t.cellSize&&angular.forEach(u,function(e){e.element[0].width=m.imageWidth*m.cellSize,e.element[0].height=m.imageHeight*m.cellSize,e.element[0].style.transform="translate("+e.offset.x*m.cellSize+"px,"+e.offset.y*m.cellSize+"px)",G(e)}))},!0),s=i.$watch("layers",function(e,t){b(e,t)},!0),c=i.$watch("shouldGenerateOutputImage",function(e){e&&(O(),a(function(){i.shouldGenerateOutputImage=!1}))}),g=i.$watch("selectedTool",function(e,t){n.info("oldValue = "+t),n.info("newValue = "+e),p=e,"move"==p&&R(null)}),d=i.$watch("revision",function(e){});var y=new Hammer(o[0]);y.on("tap",function(e){E(e)}),y.on("panstart",function(e){L(e)}),y.on("panmove",function(e){I(e)}),y.on("panend",function(e){$(e)});var b=function(e,t){o[0].querySelectorAll(".btn-remove").forEach(function(e){e.parentNode.removeChild(e)}),angular.forEach(e,function(e,i){angular.isDefined(t)&&i<t.length?angular.equals(t[i],e)||z(e,i):z(e)})},z=function(t,i){var a={offset:{x:0,y:0}};i<u.length&&"text"===u[i].type&&(a.offset=u[i].offset);var n=Object.assign({},t,a);n.element=angular.element("<canvas></canvas>");var l=n.offset.x*m.cellSize,r=n.offset.y*m.cellSize;if(n.element[0].width=m.imageWidth*m.cellSize,n.element[0].height=m.imageHeight*m.cellSize,n.element[0].style.transform="translate("+l+"px,"+r+"px)","text"===n.type&&(n.element.addClass("text"),n.btnRemove=angular.element('<button class="btn-remove"><span class="close"></span></button>'),n.btnRemove[0].style.transform="translate("+(l-16)+"px,"+(r-16)+"px)",o.append(n.btnRemove),n.btnRemove.on("click",function(){C(n),n.btnRemove.remove()})),n.active&&(n.element.addClass("active"),n.btnRemove&&n.btnRemove.addClass("active")),angular.isDefined(i)?(u[i]=n,h.find("canvas").eq(i).replaceWith(n.element)):(u.push(n),h.append(n.element)),n.dataCanvas=e[0].createElement("canvas"),n.dataCanvas.width=m.imageWidth,n.dataCanvas.height=m.imageHeight,n.image){var s=new Image;s.onload=function(){var e=n.dataCanvas.getContext("2d");e.drawImage(s,0,0),G(n)},s.src=n.image}else G(n)},C=function(e){var t=-1;angular.forEach(u,function(i,a){i===e&&(t=a)}),-1!==t&&(u[t].element.remove(),u.splice(t,1),i.layers.splice(t,1)),n.info(i.layers),a(function(){i.$digest()})},w=function(e,t,i,a,n,l,o){var r=e.getContext("2d"),s=v.createImageData(1,1);s.data[0]=a,s.data[1]=n,s.data[2]=l,s.data[3]=o,r.putImageData(s,t,i)},W=function(){var e=u[0];return angular.forEach(u,function(t){t.active&&(e=t)}),e},R=function(e){angular.forEach(u,function(t,a){a===e?(t.active=!0,t.element.addClass("active"),t.btnRemove&&t.btnRemove.addClass("active"),a<i.layers.length&&(i.layers[a].active=!0)):(t.active=!1,t.element.removeClass("active"),t.btnRemove&&t.btnRemove.addClass("active"),a<i.layers.length&&(i.layers[a].active=!1))}),a(function(){i.$digest()})},D=function(e){var t=W();if(e.pointers.length>0){var i=t.element[0].getBoundingClientRect(),a=e.pointers[0].clientX-i.left,n=e.pointers[0].clientY-i.top,l=Math.floor(a/m.cellSize),o=Math.floor(n/m.cellSize);m.paintEnabled&&(w(t.dataCanvas,l,o,m.brushColor[0],m.brushColor[1],m.brushColor[2],255),M(t,l,o,m.brushColor[0],m.brushColor[1],m.brushColor[2],255))}},E=function(e){if("move"==p)n.info("onTap [Move]");else{var t=W();if(e.target===t.element[0])"text"!==t.type&&D(e);else{var i;angular.forEach(u,function(t,a){t.element[0]===e.target&&(i=a)}),R(i)}}},L=function(e){if("move"==p)n.info("onPanStart [Move]");else{var t=W();"text"===t.type?(S.x=e.pointers[0].clientX,S.y=e.pointers[0].clientY,x.x=t.offset.x,x.y=t.offset.y):D(e)}},I=function(e){if("move"==p)n.info("onPanMove [Move]");else{var t=W();if("text"===t.type){var i=x.x*m.cellSize+(e.pointers[0].clientX-S.x),a=x.y*m.cellSize+(e.pointers[0].clientY-S.y);t.offset.x=Math.floor(i/m.cellSize),t.offset.y=Math.floor(a/m.cellSize);var l=t.offset.x*m.cellSize,o=t.offset.y*m.cellSize;t.element[0].style.transform="translate("+l+"px,"+o+"px)",t.btnRemove[0].style.transform="translate("+(l-16)+"px,"+(o-16)+"px)"}else D(e)}},$=function(){"move"==p?n.info("onPanEnd [Move]"):(angular.forEach(u,function(e,t){"image"===e.type&&t<i.layers.length&&(i.layers[t].image=e.dataCanvas.toDataURL("image/png"))}),a(function(){i.$digest()}))},G=function(e){"image"===e.type?H(e):"text"===e.type&&P(e)},P=function(e){var i=angular.element("<canvas></canvas>"),a=i[0];a.width=m.imageWidth,a.height=m.imageHeight;var n=a.getContext("2d");if(t.devicePixelRatio){var l=i.attr("width"),o=i.attr("height"),r=l,s=o;i.attr("width",l*t.devicePixelRatio),i.attr("height",o*t.devicePixelRatio),i.css("width",r),i.css("height",s),n.scale(t.devicePixelRatio,t.devicePixelRatio)}var c=e.fontSize||"10px";n.font=c+" "+(e.fontFamily||"Arial");var d=e.text||"text";n.textBaseline="top",n.fillStyle=e.color,n.fillText(d,0,0);var g=n.measureText(d);e.element[0].width=g.width*m.cellSize,e.element[0].height=parseInt(c)*m.cellSize;for(var f,v=n.getImageData(0,0,m.imageWidth,m.imageHeight),h=0;h<v.height;h++)for(var u=0;u<v.width;u++)f=4*(h*v.width+u),v.data[f+3]=v.data[f+3]>50?255:0;var p=e.dataCanvas.getContext("2d");p.putImageData(v,0,0),H(e)},H=function(e){var t,i,a,n,l,o,r,s,c=e.element[0].getContext("2d"),d=e.dataCanvas.getContext("2d"),g=d.getImageData(0,0,m.imageWidth,m.imageHeight);c.clearRect(0,0,e.element[0].width,e.element[0].height);for(var f=0;f<g.height;f++)for(var v=0;v<g.width;v++)t=4*(f*g.width+v),i=g.data[t],a=g.data[t+1],n=g.data[t+2],o=g.data[t+3],l=o/255,m.showGrid?(r=m.gridSubDivisionLineWidth,s=m.gridSubDivisionLineWidth,v%m.largeGridEvery===0&&(r=m.gridLineWidth),f%m.largeGridEvery===0&&(s=m.gridLineWidth),c.fillStyle="rgba("+i+","+a+", "+n+", "+l+")",c.fillRect(.5+m.cellSize*v+m.gridSubDivisionLineWidth+r,.5+m.cellSize*f+m.gridSubDivisionLineWidth+s,m.cellSize-2*m.gridSubDivisionLineWidth-r,m.cellSize-2*m.gridSubDivisionLineWidth-s)):(c.fillStyle="rgba("+i+","+a+", "+n+", "+l+")",c.fillRect(m.cellSize*v,m.cellSize*f,m.cellSize,m.cellSize))},M=function(e,t,i,a,n,l,o){var r=e.element[0].getContext("2d");if(r.fillStyle="rgba("+a+","+n+", "+l+", "+o+")",m.showGrid){var s=m.gridSubDivisionLineWidth,c=m.gridSubDivisionLineWidth;t%m.largeGridEvery===0&&(s=m.gridLineWidth),i%m.largeGridEvery===0&&(c=m.gridLineWidth),r.fillRect(.5+m.cellSize*t+m.gridSubDivisionLineWidth+s,.5+m.cellSize*i+m.gridSubDivisionLineWidth+c,m.cellSize-2*m.gridSubDivisionLineWidth-s,m.cellSize-2*m.gridSubDivisionLineWidth-c)}else r.fillRect(m.cellSize*t,m.cellSize*i,m.cellSize,m.cellSize)},O=function(){var e=angular.element("<canvas></canvas>"),t=e[0];t.width=m.imageWidth,t.height=m.imageHeight;var a=t.getContext("2d");angular.forEach(u,function(e){a.drawImage(e.dataCanvas,e.offset.x,e.offset.y)}),i.outputImage=a.getImageData(0,0,m.imageWidth,m.imageHeight)};i.$on("$destroy",function(){r(),s(),c(),d(),g()}),m=Object.assign(m,i.options),b(i.layers,[])}var r={restrict:"E",scope:{layers:"=",options:"=",shouldGenerateOutputImage:"=",outputImage:"=",revision:"=",selectedTool:"="},template:'<div class="layers-container"></div>',link:o};return r}]);