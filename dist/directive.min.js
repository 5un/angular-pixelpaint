/*!
 * angular-directive-boilerplate
 * 
 * Version: 0.0.14 - 2016-07-12T16:05:52.226Z
 * License: MIT
 */
/*!
 * angular-directive-boilerplate
 *
 * Version: 0.0.8 - 2016-06-16T07:54:28.642Z
 * License: MIT
 */
"use strict";angular.module("angularPixelPaint",[]).directive("pixelPaint",["$document","$window","$q","$timeout","$log",function(e,t,i,a,n){function l(e,t){t[0].style.overflow="scroll",t.css("width",t[0].style.width||"500px"),t.css("height",t[0].style.height||"500px")}function o(i,o){l(i,o),t.el=o;var r,s,c,f,d,g=e[0].createElement("canvas"),u=g.getContext("2d");o.addClass("pixelpaint");var h=angular.element(o[0].querySelector(".layers-container")),v=function(e,t){return 0>e},m=[],p={cellSize:10,largeGridEvery:10,gridLineWidth:1,gridSubDivisionLineWidth:.5,imageWidth:10,imageHeight:10,showGrid:!0,brushColor:[0,0,0],paintEnabled:!0},y="move",S={x:0,y:0},x={x:0,y:0},z={x:0,y:0};r=i.$watch("options",function(e,t){e.cellSize>0&&(p=Object.assign(p,i.options),e.cellSize!==t.cellSize&&angular.forEach(m,function(e){e.element[0].width=e.element[0].width/t.cellSize*p.cellSize,e.element[0].height=e.element[0].height/t.cellSize*p.cellSize,e.element[0].style.transform="translate("+e.offset.x*p.cellSize+"px,"+e.offset.y*p.cellSize+"px)","text"==e.type&&(e.btnRemove[0].style.transform="translate("+(e.offset.x*p.cellSize-16)+"px,"+(e.offset.y*p.cellSize-16)+"px)"),O(e)}))},!0),s=i.$watch("layers",function(e,t){w(e,t)},!0),c=i.$watch("shouldGenerateOutputImage",function(e){e&&(j(),a(function(){i.shouldGenerateOutputImage=!1}))}),d=i.$watch("selectedTool",function(e,t){n.info("oldValue = "+t),n.info("newValue = "+e),y=e,"move"==y&&I(null)}),f=i.$watch("revision",function(e){});var b=new Hammer(o[0]);b.on("tap",function(e){$(e)}),b.on("panstart",function(e){M(e)}),b.on("panmove",function(e){X(e)}),b.on("panend",function(e){Y(e)});var w=function(e,t){o[0].querySelectorAll(".btn-remove").forEach(function(e){e.parentNode.removeChild(e)}),angular.forEach(e,function(e,i){angular.isDefined(t)&&i<t.length?angular.equals(t[i],e)||C(e,i):C(e)})},C=function(t,i){var a={offsetX:0,offsetY:0};i<m.length&&"text"===m[i].type&&(a.offset=m[i].offset);var n=Object.assign({},a,t);n.element=angular.element("<canvas></canvas>");var l=n.offsetX*p.cellSize,r=n.offsetY*p.cellSize;if(n.offset={x:n.offsetX,y:n.offsetY},n.element[0].width=p.imageWidth*p.cellSize,n.element[0].height=p.imageHeight*p.cellSize,n.element[0].style.transform="translate("+l+"px,"+r+"px)","text"===n.type&&(n.element.addClass("text"),n.btnRemove=angular.element('<button class="btn-remove"><span class="close"></span></button>'),n.btnRemove[0].style.transform="translate("+(l-16)+"px,"+(r-16)+"px)",o.append(n.btnRemove),n.btnRemove.on("click",function(){W(n),n.btnRemove.remove()})),n.active&&(n.element.addClass("active"),n.btnRemove&&n.btnRemove.addClass("active")),angular.isDefined(i)?(m[i]=n,h.find("canvas").eq(i).replaceWith(n.element)):(m.push(n),h.append(n.element)),n.dataCanvas=e[0].createElement("canvas"),n.dataCanvas.width=n.element[0].width,n.dataCanvas.height=n.element[0].height,n.image){var s=new Image;s.onload=function(){var e=n.dataCanvas.getContext("2d");e.drawImage(s,0,0),O(n)},s.src=n.image}else O(n)},W=function(e){var t=-1;angular.forEach(m,function(i,a){i===e&&(t=a)}),-1!==t&&(m[t].element.remove(),m.splice(t,1),i.layers.splice(t,1)),n.info(i.layers),a(function(){i.$digest()})},D=function(e,t,i,a,n,l,o){var r=e.getContext("2d"),s=u.createImageData(1,1);s.data[0]=a,s.data[1]=n,s.data[2]=l,s.data[3]=o,r.putImageData(s,t,i)},E=function(){var e=m[0];return angular.forEach(m,function(t){t.active&&(e=t)}),e},R=function(){var e=i.layers[0];return angular.forEach(i.layers,function(t){t.active&&(e=t)}),e},I=function(e){angular.forEach(m,function(t,a){a===e?(t.active=!0,t.element.addClass("active"),t.btnRemove&&t.btnRemove.addClass("active"),a<i.layers.length&&(i.layers[a].active=!0)):(t.active=!1,t.element.removeClass("active"),t.btnRemove&&t.btnRemove.addClass("active"),a<i.layers.length&&(i.layers[a].active=!1))}),a(function(){i.$digest()})},L=function(e){var t=E();if(e.pointers.length>0){var i=t.element[0].getBoundingClientRect(),a=e.pointers[0].clientX-i.left,n=e.pointers[0].clientY-i.top,l=Math.floor(a/p.cellSize),o=Math.floor(n/p.cellSize);p.paintEnabled&&(D(t.dataCanvas,l,o,p.brushColor[0],p.brushColor[1],p.brushColor[2],255),T(t,l,o,p.brushColor[0],p.brushColor[1],p.brushColor[2],255))}},$=function(e){if("move"==y)S.x=e.pointers[0].clientX,S.y=e.pointers[0].clientY;else{var t=E();if(e.target===t.element[0])"text"!==t.type&&L(e);else{var i;angular.forEach(m,function(t,a){t.element[0]===e.target&&(i=a)}),I(i)}}},M=function(e){if("move"==y)S.x=e.pointers[0].clientX,S.y=e.pointers[0].clientY,x.x=z.x,x.y=z.y;else{var t=E();"text"===t.type?(S.x=e.pointers[0].clientX,S.y=e.pointers[0].clientY,x.x=t.offset.x,x.y=t.offset.y):L(e)}},G=function(e){return Math.floor(e/p.cellSize)*p.cellSize},X=function(e){if("move"==y){n.info("onPanMove [Move]");var t=(x.x*p.cellSize,x.y*p.cellSize,{});t.x=x.x*p.cellSize+(e.pointers[0].clientX-S.x),t.y=x.y*p.cellSize+(e.pointers[0].clientY-S.y);var i=p.imageWidth*p.cellSize,a=p.imageHeight*p.cellSize,l=v(G(t.x),i),r=v(G(t.y),a);l||r?l?r||(z.y=Math.floor(t.y/p.cellSize),o[0].querySelector(".layers-container").style.transform="translate("+G(0)+"px,"+G(t.y)+"px)"):(z.x=Math.floor(t.x/p.cellSize),o[0].querySelector(".layers-container").style.transform="translate("+G(t.x)+"px,"+G(0)+"px)"):(z.x=Math.floor(t.x/p.cellSize),z.y=Math.floor(t.y/p.cellSize),o[0].querySelector(".layers-container").style.transform="translate("+G(t.x)+"px,"+G(t.y)+"px)")}else{var s=E(),c=R();if("text"===s.type){var f=x.x*p.cellSize+(e.pointers[0].clientX-S.x),d=x.y*p.cellSize+(e.pointers[0].clientY-S.y);s.offset.x=Math.floor(f/p.cellSize),s.offset.y=Math.floor(d/p.cellSize),c.offsetX=Math.floor(f/p.cellSize),c.offsetY=Math.floor(d/p.cellSize);var g=s.offset.x*p.cellSize,u=s.offset.y*p.cellSize;s.element[0].style.transform="translate("+g+"px,"+u+"px)",s.btnRemove[0].style.transform="translate("+(g-16)+"px,"+(u-16)+"px)"}else L(e)}},Y=function(){"move"==y?n.info("onPanEnd [Move]"):(angular.forEach(m,function(e,t){"image"===e.type&&t<i.layers.length&&(i.layers[t].image=e.dataCanvas.toDataURL("image/png"))}),a(function(){i.$digest()}))},O=function(e){"image"===e.type?P(e):"text"===e.type&&H(e)},q=function(e,t,i,a){i.font=a+" "+(t.fontFamily||"Arial"),i.textBaseline="top",i.fillStyle=t.color,i.fillText(e,0,0)},H=function(e){var t=angular.element("<canvas></canvas>"),i=t[0];i.width=1e4,i.height=1e4;var a=i.getContext("2d"),l=e.fontSize||"10px",o=e.text||"text";q(o,e,a,l);var r=a.measureText(o);i.width=r.width,i.height=1.5*parseInt(l),a=i.getContext("2d"),q(o,e,a,l),e.element[0].width=r.width*p.cellSize,e.element[0].height=1.5*parseInt(l)*p.cellSize,n.info(parseInt(l));var s=a.getImageData(0,0,r.width,1.5*parseInt(l)),c=0,f=0,d=0;if(0===e.color.indexOf("rgba")){var g=e.color,u=g.substring(g.indexOf("(")+1,g.lastIndexOf(")")).split(/,\s*/);c=u[0],f=u[1],d=u[2]}for(var h,v=0;v<s.height;v++)for(var m=0;m<s.width;m++)h=4*(v*s.width+m),s.data[h]=s.data[h+3]>50?c:0,s.data[h+1]=s.data[h+3]>50?f:0,s.data[h+2]=s.data[h+3]>50?d:0,s.data[h+3]=s.data[h+3]>50?255:0;var y=e.dataCanvas.getContext("2d");y.putImageData(s,0,0),P(e)},P=function(e){var t,i,a,n,l,o,r,s,c=e.element[0].getContext("2d"),f=e.dataCanvas.getContext("2d"),d=f.getImageData(0,0,e.element[0].width/p.cellSize,e.element[0].height/p.cellSize);c.clearRect(0,0,e.element[0].width,e.element[0].height);for(var g=0;g<d.height;g++)for(var u=0;u<d.width;u++)t=4*(g*d.width+u),i=d.data[t],a=d.data[t+1],n=d.data[t+2],o=d.data[t+3],l=o/255,p.showGrid?(r=p.gridSubDivisionLineWidth,s=p.gridSubDivisionLineWidth,u%p.largeGridEvery===0&&(r=p.gridLineWidth),g%p.largeGridEvery===0&&(s=p.gridLineWidth),c.fillStyle="rgba("+i+","+a+", "+n+", "+l+")",c.fillRect(.5+p.cellSize*u+p.gridSubDivisionLineWidth+r,.5+p.cellSize*g+p.gridSubDivisionLineWidth+s,p.cellSize-2*p.gridSubDivisionLineWidth-r,p.cellSize-2*p.gridSubDivisionLineWidth-s)):(c.fillStyle="rgba("+i+","+a+", "+n+", "+l+")",c.fillRect(p.cellSize*u,p.cellSize*g,p.cellSize,p.cellSize))},T=function(e,t,i,a,n,l,o){var r=e.element[0].getContext("2d");if(r.fillStyle="rgba("+a+","+n+", "+l+", "+o+")",p.showGrid){var s=p.gridSubDivisionLineWidth,c=p.gridSubDivisionLineWidth;t%p.largeGridEvery===0&&(s=p.gridLineWidth),i%p.largeGridEvery===0&&(c=p.gridLineWidth),r.fillRect(.5+p.cellSize*t+p.gridSubDivisionLineWidth+s,.5+p.cellSize*i+p.gridSubDivisionLineWidth+c,p.cellSize-2*p.gridSubDivisionLineWidth-s,p.cellSize-2*p.gridSubDivisionLineWidth-c)}else r.fillRect(p.cellSize*t,p.cellSize*i,p.cellSize,p.cellSize)},j=function(){var e=angular.element("<canvas></canvas>"),t=e[0];t.width=p.imageWidth,t.height=p.imageHeight;var a=t.getContext("2d");angular.forEach(m,function(e){a.drawImage(e.dataCanvas,e.offset.x,e.offset.y)}),i.outputImage=a.getImageData(0,0,p.imageWidth,p.imageHeight)};i.$on("$destroy",function(){r(),s(),c(),f(),d()}),p=Object.assign(p,i.options),w(i.layers,[])}var r={restrict:"E",scope:{layers:"=",options:"=",shouldGenerateOutputImage:"=",outputImage:"=",revision:"=",selectedTool:"="},template:'<div class="layers-container"></div>',link:o};return r}]);